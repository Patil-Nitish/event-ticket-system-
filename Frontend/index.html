<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Registration System</title>

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #4338ca;
      --text: #1f2937;
      --text-light: #6b7280;
      --border: #e5e7eb;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --radius: 12px;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
      --transition: all 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Landing page */
    .landing-page {
      min-height: calc(100vh - 80px); /* Adjusted to account for header */
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: white;
      flex: 1;
    }

    .landing-content {
      max-width: 800px;
      text-align: center;
    }

    .landing-title {
      font-size: 3rem;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .landing-subtitle {
      font-size: 1.2rem;
      margin-bottom: 40px;
      opacity: 0.9;
    }

    .landing-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .feature {
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
    }

    .feature-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      display: block;
    }

    .feature h3 {
      margin-bottom: 10px;
      font-size: 1.3rem;
    }

    .feature p {
      opacity: 0.8;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 20px 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
      color: white;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1::before {
      content: "üéü";
      font-size: 26px;
    }

    .header-buttons {
      display: flex;
      gap: 12px;
    }

    main {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 24px;
      width: 100%;
    }

    .hidden {
      display: none !important; /* Added !important to ensure visibility toggles work strictly */
    }

    .btn {
      padding: 12px 24px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 10px rgba(79, 70, 229, 0.2);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 24px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title::after {
      content: "";
      flex: 1;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light) 0%, transparent 100%);
      border-radius: 2px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: var(--transition);
      border: 1px solid transparent;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      border-color: rgba(79, 70, 229, 0.1);
    }

    .card h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .card p {
      margin: 0;
      font-size: 14px;
      color: var(--text-light);
    }

    .form-card {
      max-width: 480px;
      margin-bottom: 48px;
      border-top: 4px solid var(--primary);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    input,
    select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 2px solid var(--border);
      font-size: 15px;
      transition: var(--transition);
      background: white;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .status-success {
      color: var(--success);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: rgba(16, 185, 129, 0.08);
      border-radius: 10px;
      border-left: 4px solid var(--success);
    }

    .status-success::before {
      content: "‚úì";
      font-size: 20px;
    }

    .status-error {
      color: var(--error);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: rgba(239, 68, 68, 0.08);
      border-radius: 10px;
      border-left: 4px solid var(--error);
    }

    .status-error::before {
      content: "‚úó";
      font-size: 20px;
    }

    .status-warning {
      color: var(--warning);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: rgba(245, 158, 11, 0.08);
      border-radius: 10px;
      border-left: 4px solid var(--warning);
    }

    .status-warning::before {
      content: "‚ö†";
      font-size: 20px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-row span {
      color: var(--text-light);
      font-size: 14px;
    }

    .stat-row strong {
      color: var(--text);
      font-size: 16px;
      font-weight: 700;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.5px;
      width: fit-content;
    }

    .badge-open {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .badge-full {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .dashboard-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      margin: 32px 0;
      flex-wrap: wrap;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(79, 70, 229, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      text-align: center;
      padding: 64px 32px;
      color: var(--text-light);
    }

    .empty-state::before {
      content: "üìÖ";
      font-size: 48px;
      margin-bottom: 20px;
      display: block;
    }

    @media (max-width: 768px) {
      .landing-title {
        font-size: 2.2rem;
      }
      
      .landing-features {
        grid-template-columns: 1fr;
      }
      
      main {
        margin: 24px auto;
        padding: 0 16px;
      }

      header {
        padding: 16px;
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .header-buttons {
        width: 100%;
        flex-direction: column;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .landing-title {
        font-size: 1.8rem;
      }
      
      .landing-subtitle {
        font-size: 1rem;
      }
      
      .feature {
        padding: 20px;
      }
      
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
    }
  </style>
</head>

<body>

  <header>
    <h1>Event Registration System</h1>
    <div class="header-buttons">
      <button id="loginBtn" class="btn btn-primary">
        <span>üîê</span>
        <span>Login</span>
      </button>
      <button id="logoutBtn" class="btn btn-outline hidden">
        <span>üö™</span>
        <span>Logout</span>
      </button>
    </div>
  </header>

  <div id="landingPage" class="landing-page">
    <div class="landing-content">
      <h1 class="landing-title">Event Registration System</h1>
      <p class="landing-subtitle">Create, manage, and attend events with our easy-to-use platform</p>
      
      <div class="landing-features">
        <div class="feature">
          <span class="feature-icon">üéØ</span>
          <h3>Easy Setup</h3>
          <p>Create events in minutes with simple forms</p>
        </div>
        
        <div class="feature">
          <span class="feature-icon">üìä</span>
          <h3>Live Tracking</h3>
          <p>Monitor registrations and attendance in real time</p>
        </div>
        
        <div class="feature">
          <span class="feature-icon">üîí</span>
          <h3>Secure Payments</h3>
          <p>Integrated payment processing with top security</p>
        </div>
      </div>
    </div>
  </div>

  <main id="app" class="hidden">
    <div class="dashboard-header">
      <div class="dashboard-icon" id="roleIcon"></div>
      <div>
        <h2 id="userRole" class="section-title"></h2>
        <p id="welcomeMessage" style="color: var(--text-light);"></p>
      </div>
    </div>

    <section id="organizerSection" class="hidden">
      <div class="action-buttons">
        <button onclick="createEventHandler(this)" class="btn btn-primary">
          <span>‚ûï</span>
          <span>Create New Event</span>
        </button>
        <a href="scan.html" target="_blank" class="btn btn-outline"
          style="border-color: var(--primary); color: var(--primary);">
          <span>üì∑</span>
          <span>Open Scan Page</span>
        </a>
      </div>

      <div class="card form-card">
        <h3 style="margin-bottom: 20px;">Create New Event</h3>
        <div class="form-group">
          <label for="title" class="form-label">Event Title</label>
          <input id="title" placeholder="Enter event title" />
        </div>
        <div class="form-group">
          <label for="capacity" class="form-label">Capacity</label>
          <input id="capacity" type="number" placeholder="Enter maximum attendees" min="1" />
        </div>
        <button class="btn btn-primary" onclick="createEventHandler(this)" style="width: 100%;">
          <span>‚ú®</span>
          <span>Create Event</span>
        </button>
      </div>

      <h3 class="section-title">Your Events</h3>
      <div id="myEvents" class="grid">
        <div class="empty-state" id="emptyEvents" style="display: none;">
          <h3>No events yet</h3>
          <p>Create your first event to get started</p>
        </div>
      </div>
    </section>

    <section id="attendeeSection" class="hidden">
      <div class="card form-card">
        <h3 style="margin-bottom: 20px;">Register for an Event</h3>
        <div id="eventStatusMessage" style="margin-bottom: 16px; display: none;"></div>
        <div class="form-group">
          <label for="eventSelect" class="form-label">Select Event</label>
          <select id="eventSelect" onchange="updateEventStatus()">
            <option value="">Loading events...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="email" class="form-label">Your Email</label>
          <input id="email" type="email" placeholder="Enter your email address" />
        </div>
        <button class="btn btn-primary" onclick="payForEvent()" style="width: 100%; margin-bottom: 12px;">
          <span>üí≥</span>
          <span> Pay</span>
        </button>
        <button class="btn btn-primary" onclick="register()" style="width: 100%;">
          <span>üéü</span>
          <span> Register</span>
        </button>
        <div id="registerResult" style="margin-top: 20px;"></div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="refreshEvents()" class="btn btn-outline"
          style="border-color: var(--primary); color: var(--primary); font-size: 14px; padding: 10px 20px;">
          <span>üîÑ</span>
          <span>Refresh Events</span>
        </button>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "https://tnzlib1yia.execute-api.us-east-1.amazonaws.com/prod";
    const COGNITO_DOMAIN = "https://us-east-1p9jovxmbg.auth.us-east-1.amazoncognito.com";
    const CLIENT_ID = "2ia4957lvacmn4tic5b2fkjir9";
    const FRONTEND = "https://d32859v82pelel.cloudfront.net";
    let eventStatsCache = {};

    // Update the UI based on login state
    function updateUIForLoginState(isLoggedIn) {
      if (isLoggedIn) {
        // Hide landing page, show main app
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        // Show logout, hide login
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
      } else {
        // Show landing page, hide main app
        document.getElementById('landingPage').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
        // Show login, hide logout
        document.getElementById('loginBtn').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.add('hidden');
      }
    }

    document.getElementById("loginBtn").onclick = () => {
      window.location.href =
        `${COGNITO_DOMAIN}/login` +
        `?client_id=${CLIENT_ID}` +
        `&response_type=token` +
        `&scope=openid+email` +
        `&redirect_uri=${encodeURIComponent(FRONTEND)}`;
    };

    function logout() {
      localStorage.removeItem("id_token");
      localStorage.removeItem("paid_events");
      localStorage.removeItem("last_payment_event_id");
      window.location.href =
        `${COGNITO_DOMAIN}/logout` +
        `?client_id=${CLIENT_ID}` +
        `&logout_uri=${encodeURIComponent(FRONTEND)}`;
    }

    document.getElementById("logoutBtn").onclick = logout;

    function parseToken() {
      let token = null;

      const params = new URLSearchParams(window.location.search);
      const isStripeReturn = params.has("paid");

      if (location.hash) {
        const hashParams = new URLSearchParams(location.hash.substring(1));
        token = hashParams.get("id_token");
        if (token) {
          localStorage.setItem("id_token", token);
          location.hash = "";
        }
      }

      if (!token && isStripeReturn) {
        token = localStorage.getItem("id_token");
      }

      if (!token) {
        updateUIForLoginState(false);
        return;
      }

      initApp(token);

      if (isStripeReturn) {
        setTimeout(handleStripeReturn, 100);
      }
    }

    function initApp(token) {
      updateUIForLoginState(true);

      const payload = JSON.parse(atob(token.split(".")[1]));
      const groups = payload["cognito:groups"] || [];
      const email = payload["email"] || "";

      document.getElementById("welcomeMessage").textContent = email ? `Welcome, ${email}` : "Welcome";

      if (groups.includes("organizer")) {
        userRole.innerText = "Organizer Dashboard";
        roleIcon.innerHTML = "üìä";
        organizerSection.classList.remove("hidden");
        loadMyEvents();
      } else {
        userRole.innerText = "Attendee Dashboard";
        roleIcon.innerHTML = "üë§";
        attendeeSection.classList.remove("hidden");
        loadEvents();
        setTimeout(updateEventStatus, 500);
      }
    }

    // Initial check
    parseToken();

    // If no token and not in Stripe return, show landing page with login button
    if (!localStorage.getItem("id_token") && !location.hash && !new URLSearchParams(window.location.search).has("paid")) {
      updateUIForLoginState(false);
    }

    async function performRegistration(eventId, userEmail) {
      const token = localStorage.getItem("id_token");
      const resultDiv = document.getElementById("registerResult");

      if (!token) {
        resultDiv.className = "status-error";
        resultDiv.textContent = "Please log in again";
        return null;
      }

      try {
        const res = await fetch(API_BASE + "/register", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            eventId: eventId,
            email: userEmail
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || "Registration failed.");
        }

        return data;

      } catch (error) {
        console.error("Registration error:", error);
        throw error;
      }
    }

    async function handleStripeReturn() {
      const params = new URLSearchParams(window.location.search);
      const paid = params.get("paid");
      const eventId = params.get("eventId");
      const sessionId = params.get("sessionId");

      if (paid === "true" && eventId) {
        const paidEvents = JSON.parse(localStorage.getItem("paid_events") || "[]");
        if (!paidEvents.includes(eventId)) {
          paidEvents.push(eventId);
          localStorage.setItem("paid_events", JSON.stringify(paidEvents));
        }

        if (sessionId) {
          localStorage.setItem(`payment_session_${eventId}`, sessionId);
        }

        const token = localStorage.getItem("id_token");
        let userEmail = "";

        if (token) {
          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            userEmail = payload["email"] || "";
          } catch (e) {
            console.error("Failed to parse token:", e);
          }
        }

        const eventSelect = document.getElementById("eventSelect");
        if (eventSelect) {
          eventSelect.value = eventId;
          await updateEventStatsInCache(eventId);
        }

        const emailInput = document.getElementById("email");
        if (emailInput && userEmail) {
          emailInput.value = userEmail;
        }

        const resultDiv = document.getElementById("registerResult");
        resultDiv.className = "status-success";

        if (userEmail) {
          resultDiv.innerHTML = "Payment successful! Auto-registering now...";

          setTimeout(() => {
            autoRegisterAfterPayment(eventId, userEmail);
          }, 1000);
        } else {
          resultDiv.innerHTML = `
        Payment successful!<br>
        <small>Please enter your email and click "Register" to get your ticket.</small>
      `;
        }
      }

      if (paid === "false") {
        const resultDiv = document.getElementById("registerResult");
        resultDiv.className = "status-error";
        resultDiv.innerHTML = "Payment cancelled or failed.";
      }

      window.history.replaceState({}, document.title, "/");
    }

    async function autoRegisterAfterPayment(eventId, userEmail) {
      const resultDiv = document.getElementById("registerResult");

      resultDiv.className = "";
      resultDiv.innerHTML = '<span class="loading-spinner"></span> Processing your registration...';

      try {
        const data = await performRegistration(eventId, userEmail);

        resultDiv.className = "status-success";
        resultDiv.innerHTML = `
      <div style="margin-bottom: 16px;">
        <strong>Registration successful!</strong><br>
        <span style="font-size: 14px; color: var(--text-light);">Your ticket is ready for download.</span>
      </div>
      <a href="${data.ticketUrl}" target="_blank" class="btn btn-primary" style="width: 100%; margin-bottom: 8px;">
        <span>‚¨á</span>
        <span>Download Ticket (PDF)</span>
      </a>
      <p style="margin-top: 8px; font-size: 12px; color: var(--text-light); text-align: center;">
        Ticket will download automatically in a new tab
      </p>
    `;

        const paidEvents = JSON.parse(localStorage.getItem("paid_events") || "[]");
        const updatedPaidEvents = paidEvents.filter(id => id !== eventId);
        localStorage.setItem("paid_events", JSON.stringify(updatedPaidEvents));

        await updateEventStatsInCache(eventId);

        document.getElementById("email").value = "";

        setTimeout(() => {
          window.open(data.ticketUrl, '_blank');
        }, 500);

      } catch (error) {
        resultDiv.className = "status-error";
        resultDiv.innerHTML = `
      Auto-registration failed: ${error.message}<br>
      <small>Please click the "Register" button to try again.</small>
    `;
      }
    }

    async function createEventHandler(button) {
      const token = localStorage.getItem("id_token");
      const createBtn = button;
      const originalText = createBtn.innerHTML;

      createBtn.innerHTML = '<span class="loading-spinner"></span><span>Creating...</span>';
      createBtn.disabled = true;

      try {
        const res = await fetch(API_BASE + "/events", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            title: title.value,
            capacity: Number(capacity.value)
          })
        });

        const data = await res.json();
        title.value = "";
        capacity.value = "";
        loadMyEvents();
        eventStatsCache = {};

        const registerResult = document.getElementById('registerResult');
        registerResult.className = "status-success";
        registerResult.innerHTML = "Event created successfully!";
        setTimeout(() => registerResult.innerHTML = "", 3000);

      } catch (error) {
        console.error("Error creating event:", error);
      } finally {
        createBtn.innerHTML = originalText;
        createBtn.disabled = false;
      }
    }

    async function loadMyEvents() {
      const token = localStorage.getItem("id_token");
      const container = document.getElementById("myEvents");
      const emptyState = document.getElementById("emptyEvents");

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner"></span></div>';

      try {
        const res = await fetch(API_BASE + "/events", {
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const events = await res.json();
        container.innerHTML = "";

        if (events.length === 0) {
          if (emptyState) {
            emptyState.style.display = "block";
          } else {
            const newEmptyState = document.createElement("div");
            newEmptyState.className = "empty-state";
            newEmptyState.id = "emptyEvents";
            newEmptyState.innerHTML = `
          <h3>No events yet</h3>
          <p>Create your first event to get started</p>
        `;
            container.appendChild(newEmptyState);
          }
          return;
        }

        if (emptyState) {
          emptyState.style.display = "none";
        }

        events.forEach(event => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
        <h3>${event.title}</h3>
        <p style="color: var(--text-light)">Event ID: ${event.eventId}</p>
        <div style="text-align: center; padding: 20px;">
          <span class="loading-spinner"></span>
          <p style="margin-top: 10px; color: var(--text-light);">Loading analytics...</p>
        </div>
      `;
          container.appendChild(card);

          fetch(`${API_BASE}/events/${event.eventId}/stats`, {
            headers: {
              "Authorization": "Bearer " + token
            }
          })
            .then(res => res.json())
            .then(stats => {
              const statusClass = stats.status === "OPEN" ? "badge-open" : "badge-full";
              const statusIcon = stats.status === "OPEN" ? "üü¢" : "üî¥";

              card.innerHTML = `
          <h3>${event.title}</h3>
          <p style="color: var(--text-light); font-size: 13px;">ID: ${event.eventId}</p>

          <div class="stat-row">
            <span>Capacity</span>
            <strong>${stats.capacity}</strong>
          </div>

          <div class="stat-row">
            <span>Registered</span>
            <strong>${stats.registered}</strong>
          </div>

          <div class="stat-row">
            <span>Remaining</span>
            <strong style="color: ${stats.remaining > 0 ? 'var(--success)' : 'var(--error)'}">${stats.remaining}</strong>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
            <span class="badge ${statusClass}">
              ${statusIcon} ${stats.status}
            </span>
            <span style="font-size: 12px; color: var(--text-light);">
              ${Math.round((stats.registered / stats.capacity) * 100)}% full
            </span>
          </div>
        `;
            })
            .catch(() => {
              card.innerHTML += `<p class="status-error">Failed to load analytics</p>`;
            });
        });
      } catch (error) {
        console.error("loadMyEvents error:", error);
        container.innerHTML = `
      <div class="status-error">
        Failed to load events. Check console.
      </div>
    `;
      }
    }

    async function loadEvents() {
      const token = localStorage.getItem("id_token");
      const eventSelect = document.getElementById("eventSelect");

      eventSelect.innerHTML = '<option value="">Loading events...</option>';

      try {
        const res = await fetch(API_BASE + "/events", {
          headers: { "Authorization": "Bearer " + token }
        });

        const events = await res.json();
        eventSelect.innerHTML = "";

        if (events.length === 0) {
          eventSelect.innerHTML = '<option value="">No events available</option>';
          return;
        }

        eventSelect.innerHTML = '<option value="">Select an event...</option>';

        const statsPromises = events.map(async e => {
          try {
            const statsRes = await fetch(`${API_BASE}/events/${e.eventId}/stats`, {
              headers: { "Authorization": "Bearer " + token }
            });
            const stats = await statsRes.json();
            eventStatsCache[e.eventId] = stats;

            const percentageFull = Math.round((stats.registered / stats.capacity) * 100);
            let statusEmoji = "üü¢";
            if (percentageFull >= 100) statusEmoji = "üî¥";
            else if (percentageFull >= 70) statusEmoji = "üü°";

            return {
              event: e,
              stats: stats,
              option: {
                value: e.eventId,
                text: `${statusEmoji} ${e.title} ‚Ä¢ ${stats.remaining} seats left (${percentageFull}% full)`
              }
            };
          } catch (error) {
            console.error(`Failed to load stats for event ${e.eventId}:`, error);
            return {
              event: e,
              stats: null,
              option: {
                value: e.eventId,
                text: `${e.title} ‚Ä¢ ${e.capacity} seats available`
              }
            };
          }
        });

        const eventsWithStats = await Promise.all(statsPromises);

        eventsWithStats.sort((a, b) => {
          if (a.stats && b.stats) {
            const aPercent = (a.stats.registered / a.stats.capacity) * 100;
            const bPercent = (b.stats.registered / b.stats.capacity) * 100;

            if (aPercent >= 100 && bPercent < 100) return 1;
            if (aPercent < 100 && bPercent >= 100) return -1;

            return bPercent - aPercent;
          }
          return 0;
        });

        eventsWithStats.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.option.value;
          opt.textContent = item.option.text;
          opt.dataset.title = item.event.title;
          
          if (item.stats && item.stats.remaining <= 0) {
            opt.disabled = true;
            opt.style.color = "#ef4444";
          }
          
          eventSelect.appendChild(opt);
        });

      } catch (error) {
        eventSelect.innerHTML = '<option value="">Failed to load events</option>';
      }
    }

    function updateEventStatus() {
      const eventId = document.getElementById("eventSelect").value;
      const statusDiv = document.getElementById("eventStatusMessage");

      if (!eventId) {
        statusDiv.style.display = "none";
        return;
      }

      const stats = eventStatsCache[eventId];
      if (!stats) {
        statusDiv.style.display = "none";
        return;
      }

      const percentageFull = Math.round((stats.registered / stats.capacity) * 100);
      const remainingSeats = stats.remaining;

      statusDiv.style.display = "block";

      if (remainingSeats <= 0) {
        statusDiv.className = "status-error";
        statusDiv.innerHTML = `<strong>Event Fully Booked!</strong><br>
          <small>This event has no remaining seats. Please select another event.</small>`;
      } else if (percentageFull >= 70) {
        statusDiv.className = "status-warning";
        statusDiv.innerHTML = `<strong>Hurry Up! Seats Filling Fast</strong><br>
          <small>This event is ${percentageFull}% full! Only ${remainingSeats} seat${remainingSeats === 1 ? '' : 's'} left.</small>`;
      } else {
        statusDiv.className = "status-success";
        statusDiv.innerHTML = `<strong>Good Availability</strong><br>
          <small>${remainingSeats} seat${remainingSeats === 1 ? '' : 's'} available (${percentageFull}% full)</small>`;
      }
    }

    async function updateEventStatsInCache(eventId) {
      const token = localStorage.getItem("id_token");
      
      try {
        const res = await fetch(`${API_BASE}/events/${eventId}/stats`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const freshStats = await res.json();
        
        eventStatsCache[eventId] = freshStats;
        
        const eventSelect = document.getElementById("eventSelect");
        if (eventSelect) {
          const option = eventSelect.querySelector(`option[value="${eventId}"]`);
          if (option) {
            const percentageFull = Math.round((freshStats.registered / freshStats.capacity) * 100);
            let statusEmoji = "üü¢";
            if (percentageFull >= 100) statusEmoji = "üî¥";
            else if (percentageFull >= 70) statusEmoji = "üü°";
            
            option.textContent = `${statusEmoji} ${option.dataset.title || eventId} ‚Ä¢ ${freshStats.remaining} seats left (${percentageFull}% full)`;
            
            if (freshStats.remaining <= 0) {
              option.disabled = true;
              option.style.color = "#ef4444";
            } else {
              option.disabled = false;
              option.style.color = "";
            }
          }
        }
        
        if (eventSelect && eventSelect.value === eventId) {
          updateEventStatus();
        }
        
        return freshStats;
      } catch (error) {
        console.error(`Failed to update stats for event ${eventId}:`, error);
        return null;
      }
    }

    async function refreshEvents() {
      const refreshBtn = event.target;
      const originalText = refreshBtn.innerHTML;
      const currentEventId = document.getElementById("eventSelect").value;

      refreshBtn.innerHTML = '<span class="loading-spinner"></span><span>Refreshing...</span>';
      refreshBtn.disabled = true;

      try {
        eventStatsCache = {};

        await loadEvents();

        if (currentEventId) {
          document.getElementById("eventSelect").value = currentEventId;
          updateEventStatus();
        }

        const resultDiv = document.getElementById("registerResult");
        resultDiv.className = "status-success";
        resultDiv.innerHTML = "Events refreshed successfully!";
        setTimeout(() => resultDiv.innerHTML = "", 3000);

      } catch (error) {
        console.error("Refresh error:", error);
        const resultDiv = document.getElementById("registerResult");
        resultDiv.className = "status-error";
        resultDiv.innerHTML = "Failed to refresh events";
      } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
      }
    }

    async function payForEvent() {
      const payBtn = event.target;
      const originalText = payBtn.innerHTML;
      const eventId = eventSelect.value;

      if (!eventId) {
        alert("Please select an event first");
        return;
      }

      const stats = eventStatsCache[eventId];
      if (stats && stats.remaining <= 0) {
        alert("This event is fully booked! Please select another event.");
        return;
      }

      payBtn.innerHTML = '<span class="loading-spinner"></span><span>Creating payment...</span>';
      payBtn.disabled = true;

      try {
        const token = localStorage.getItem("id_token");
        const res = await fetch(API_BASE + "/pay", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            eventId: eventId,
            timestamp: Date.now()
          })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || "Payment initiation failed");
          return;
        }

        localStorage.setItem("last_payment_event_id", eventId);

        window.location.href = data.checkoutUrl;

      } catch (error) {
        alert("Network error. Please try again.");
        console.error("Payment error:", error);
      } finally {
        payBtn.innerHTML = originalText;
        payBtn.disabled = false;
      }
    }

    async function register() {
      const registerBtn = event.target;
      const originalText = registerBtn.innerHTML;
      const resultDiv = document.getElementById("registerResult");

      registerBtn.innerHTML = '<span class="loading-spinner"></span><span>Registering...</span>';
      registerBtn.disabled = true;
      resultDiv.innerHTML = "";

      const selectedEventId = document.getElementById("eventSelect").value;
      let userEmail = document.getElementById("email").value;

      const stats = eventStatsCache[selectedEventId];
      if (stats && stats.remaining <= 0) {
        resultDiv.className = "status-error";
        resultDiv.innerHTML = "This event is fully booked! Please select another event.";
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
        return;
      }

      if (!selectedEventId) {
        resultDiv.className = "status-error";
        resultDiv.innerHTML = "Please select an event first.";
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
        return;
      }

      if (!userEmail) {
        const token = localStorage.getItem("id_token");
        if (token) {
          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            userEmail = payload["email"] || "";
            if (userEmail) {
              document.getElementById("email").value = userEmail;
            }
          } catch (e) {
            console.error("Failed to parse token:", e);
          }
        }

        if (!userEmail) {
          resultDiv.className = "status-error";
          resultDiv.innerHTML = "Please enter your email address.";
          registerBtn.innerHTML = originalText;
          registerBtn.disabled = false;
          return;
        }
      }

      const paidEvents = JSON.parse(localStorage.getItem("paid_events") || "[]");

      if (!paidEvents.includes(selectedEventId)) {
        resultDiv.className = "status-error";
        resultDiv.innerHTML = `
      Payment required before registration.<br>
      <small>Please click the "Pay" button first to complete payment.</small>
    `;
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
        return;
      }

      try {
        const data = await performRegistration(selectedEventId, userEmail);

        resultDiv.className = "status-success";
        resultDiv.innerHTML = `
      <div style="margin-bottom: 16px;">
        <strong>Registration successful!</strong><br>
        <span style="font-size: 14px; color: var(--text-light);">Your ticket has been generated.</span>
      </div>
      <a href="${data.ticketUrl}" target="_blank" class="btn btn-outline" style="width: 100%; border-color: var(--primary); color: var(--primary);">
        <span>‚¨á</span>
        <span>Download Ticket (PDF)</span>
      </a>
    `;

        const updatedPaidEvents = paidEvents.filter(id => id !== selectedEventId);
        localStorage.setItem("paid_events", JSON.stringify(updatedPaidEvents));

        await updateEventStatsInCache(selectedEventId);

        document.getElementById("email").value = "";

        setTimeout(() => {
          window.open(data.ticketUrl, '_blank');
        }, 500);

      } catch (error) {
        resultDiv.className = "status-error";
        resultDiv.textContent = `${error.message || "Registration failed. Please try again."}`;
      } finally {
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
      }
    }
  </script>
</body>
</html>